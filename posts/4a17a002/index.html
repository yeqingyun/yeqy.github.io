<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  
  <title>用javascript开发一个俄罗斯方块 | 一些</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  
    <meta name="keywords" content="javascript算法游戏" />
  
  
  
    <meta name="baidu-site-verification" content="6MQccnuuGT" />
  
  
  <meta name="description" content="开发游戏不仅能学习算法，也能锻炼人的思维逻辑，提高我们的编程能力，充实我们的问题思考能力和问题解决思路。俄罗斯方块想必大家都玩过，他的游戏逻辑并不复杂，今天我们就来用大家都熟悉的javascript开发一款俄罗斯方块，后续我会写出更多关于游戏开发的文章。">
<meta name="keywords" content="javascript,算法,游戏">
<meta property="og:type" content="article">
<meta property="og:title" content="用javascript开发一个俄罗斯方块">
<meta property="og:url" content="http://ilovejava.cn/posts/4a17a002/index.html">
<meta property="og:site_name" content="一些">
<meta property="og:description" content="开发游戏不仅能学习算法，也能锻炼人的思维逻辑，提高我们的编程能力，充实我们的问题思考能力和问题解决思路。俄罗斯方块想必大家都玩过，他的游戏逻辑并不复杂，今天我们就来用大家都熟悉的javascript开发一款俄罗斯方块，后续我会写出更多关于游戏开发的文章。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2017-09-04T10:24:21.565Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="用javascript开发一个俄罗斯方块">
<meta name="twitter:description" content="开发游戏不仅能学习算法，也能锻炼人的思维逻辑，提高我们的编程能力，充实我们的问题思考能力和问题解决思路。俄罗斯方块想必大家都玩过，他的游戏逻辑并不复杂，今天我们就来用大家都熟悉的javascript开发一款俄罗斯方块，后续我会写出更多关于游戏开发的文章。">
  
    <link rel="alternate" href="/atom.xml" title="一些" type="application/atom+xml" />
  
  <link rel="icon" href="/favicon.ico" />
  
    <link href="/css/font.css" rel="stylesheet" type="text/css" />
  
  <link href="/css/font5.css" rel="stylesheet" type="text/css" />
  <link href="/css/font4.css" rel="stylesheet" type="text/css" />
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" />
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="/css/font2.css" type="text/css" media="all" />

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="/css/font3.css" type="text/css" media="all" />
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/nprogress.css">
  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" />
  <link rel="stylesheet" href="/css/fashion.css" />
  <link rel="stylesheet" href="/css/glyphs.css" />

</head>


</head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  
  <div class="site-header-image">
  </div>

  <div id="header-blur" class="site-header-image blur" style="position: absolute; top:0; height: 207px; min-height: 207px; min-width: 100%;">
  </div>




<header id="allheader" class="site-header" role="banner" 
   style="width: 100%; position: absolute; top:0; background: rgba(255,255,255,.8);"  >
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="一些" rel="home"> 一些 </a>
            
          </h1>
          
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows"  style="touch-action: pan-y;">
                    
                      
                        <li data="index" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">首页</a> </li>
                         
                    
                      
                         <li data="/archives" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/archives">归档</a> </li>
                         
                    
                      
                         <li data="/categories" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/categories">分类</a> </li>
                         
                    
                      
                         <li data="/tags" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/tags">标签</a> </li>
                         
                    
                      
                         <li data="/about" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">关于</a> </li>
                         
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-用javascript开发一个俄罗斯方块" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      用javascript开发一个俄罗斯方块
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/posts/4a17a002/" class="article-date">
	  <time datetime="2016-06-09T05:36:43.000Z" itemprop="datePublished">六月 9, 2016</time>
	</a>

       
      
	<span id="busuanzi_container_page_pv">
	  本文总阅读量<span id="busuanzi_value_page_pv"></span>次
	</span>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>开发游戏不仅能学习算法，也能锻炼人的思维逻辑，提高我们的编程能力，充实我们的问题思考能力和问题解决思路。俄罗斯方块想必大家都玩过，他的游戏逻辑并不复杂，今天我们就来用大家都熟悉的javascript开发一款俄罗斯方块，后续我会写出更多关于游戏开发的文章。</p>
<a id="more"></a>
<h3 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h3><p>es5 + webpack </p>
<p>本文重点在讲解俄罗斯方块游戏的逻辑，如果不了解webpack的话可以去<a href="https://doc.webpack-china.org/" target="_blank" rel="external">webpack</a>官网查看相关文档，在这里我们不就不赘述了。代码中主要用到都是包括es5之前的语法以及api，因为es6、es7不是本文章的重点。</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p><a href="https://github.com/yeqingyun/Square" target="_blank" rel="external">源码</a>在我的github仓库中，大家可以看一看，代码重点在实现游戏逻辑，大家可以根据自己的需求进行优化。</p>
<h3 id="在线演示"><a href="#在线演示" class="headerlink" title="在线演示"></a>在线演示</h3><p><a href="../../projects/games/square_1/index.html">俄罗斯方块</a>  </p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>好了，开始解释代码吧，由于代码细节较多，在此我只说明一下重要的部分和总的思路。  </p>
<h4 id="index-html"><a href="#index-html" class="headerlink" title="index.html"></a>index.html</h4><pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;

&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;
    &lt;title&gt;Square&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;div id=&quot;local_game&quot; class=&quot;game&quot;&gt;&lt;/div&gt;
    &lt;div id=&quot;local_gameover&quot; class=&quot;gameover&quot;&gt;游戏结束&lt;/div&gt;
    &lt;div id=&quot;local_next&quot; class=&quot;next&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;info&quot;&gt;
        &lt;div&gt;已用时:&lt;span id=&quot;local_time&quot;&gt;0&lt;/span&gt;&lt;/div&gt;
        &lt;div&gt;已得分:&lt;span id=&quot;local_score&quot;&gt;0&lt;/span&gt;&lt;/div&gt;
        &lt;div class=&quot;btnWarp&quot;&gt;&lt;a href=&quot;javascript:void(0)&quot; id=&quot;local_start&quot; class=&quot;btn&quot;&gt;开始&lt;/a&gt;&lt;/div&gt;
        &lt;div class=&quot;btnWarp&quot;&gt;&lt;a href=&quot;javascript:void(0)&quot; id=&quot;local_pause&quot; class=&quot;btn&quot;&gt;暂停&lt;/a&gt;&lt;/div&gt;
        &lt;div class=&quot;btnWarp&quot;&gt;&lt;a href=&quot;javascript:void(0)&quot; id=&quot;local_stop&quot; class=&quot;btn&quot;&gt;结束&lt;/a&gt;&lt;/div&gt;
        &lt;div class=&quot;introduce&quot;&gt;
            操作说明：
            &lt;p&gt;↑：变换 ↓：下落&lt;/p&gt;
            &lt;p&gt;←：左移 →：右移&lt;/p&gt;
            &lt;p&gt;空格：坠落&lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre><p>这是主页的html代码，俄罗斯方块的所有操作都在这个页面完成，我们的代码也只有这一个html页面。<code>local\_game</code>是显示我们游戏中操作方块的区域，<code>loacl\_gamover</code>是显示游戏结束的隐藏区域，<code>local_next</code>是显示下一个方块的区域。之所以有一个前缀loacl是因为这个游戏后续将会加上与服务器的交互逻辑，这个将在以下篇文章提到，现在可以省略。<br>接下来是业务的实现代码，我们的js分几个模块，下面将解释每个模块的作用</p>
<h4 id="game-js"><a href="#game-js" class="headerlink" title="game.js"></a>game.js</h4><p>game.js主要是控制方块的数据变化，dom节点的操作。  </p>
<pre><code>import _ from &apos;lodash&apos;;
import Square from &quot;./square.js&quot;;
import SquareFactory from &quot;./squareFactory.js&quot;;

export default function () {

    var gameData = [
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    ]

    var dataClass = [
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    ]



    var cur, next
    var gameContainers, nextContainers, timeDiv, gameoverDiv, scoreDiv
    var gameDivs = [], nextDivs = []
    //初始化容器
    var initDiv = function (data, container, divs) {
        for (var i = 0; i &lt; data.length; i++) {
            var gameDiv = []
            for (var j = 0; j &lt; data[0].length; j++) {
                var newNode = document.createElement(&quot;div&quot;)
                newNode.className = &apos;none&apos;
                container.appendChild(newNode)
                gameDiv.push(newNode)
            }
            Array.prototype.push.call(divs, gameDiv)
        }
    }
    //刷新容器显示
    var flushDiv = function (data, divs, classes) {
        for (var i = 0; i &lt; data.length; i++) {
            for (var j = 0; j &lt; data[0].length; j++) {
                if (data[i][j] == 0) {
                    divs[i][j].className = &apos;none&apos;
                } else {
                    if (!classes[i][j])
                        classes[i][j] = &apos;A&apos;
                    divs[i][j].className = classes[i][j]
                }
            }
        }
    }
    //检测点是否合法
    var checkPonit = function (pox, x, y) {
        if (pox.x + x &lt; 0) {
            return false
        } else if (pox.x + x &gt;= gameData.length) {
            return false
        } else if (pox.y + y &lt; 0) {
            return false
        } else if (pox.y + y &gt;= gameData[0].length) {
            return false
        } else if (gameData[pox.x + x][pox.y + y] == 1) {
            return false
        }
        return true
    }
    //监测数据是否合法
    var valid = function (pos, data) {
        for (var i = 0; i &lt; data.length; i++) {
            for (var j = 0; j &lt; data[0].length; j++) {
                if (data[i][j] != 0) {
                    if (!checkPonit(pos, i, j)) {
                        return false;
                    }
                }
            }
        }
        return true;
    }

    //设置数据
    var setData = function () {
        for (var i = 0; i &lt; cur.data.length; i++) {
            for (var j = 0; j &lt; cur.data[0].length; j++) {
                if (checkPonit(cur.orgin, i, j)) {
                    gameData[i + cur.orgin.x][j + cur.orgin.y] = cur.data[i][j]
                    dataClass[i + cur.orgin.x][j + cur.orgin.y] = cur.class
                }
            }
        }
    }
    //清除数据
    var clearData = function () {
        for (var i = 0; i &lt; cur.data.length; i++) {
            for (var j = 0; j &lt; cur.data[0].length; j++) {
                if (checkPonit(cur.orgin, i, j)) {
                    gameData[cur.orgin.x + i][cur.orgin.y + j] = 0
                    dataClass[i + cur.orgin.x][j + cur.orgin.y] = &apos;none&apos;
                }
            }
        }
    }

    var setTime = function (data) {
        if (timeDiv) {
            timeDiv.innerText = data
        }
    }

    var showGameOver = function () {
        gameoverDiv.style.display = &apos;block&apos;
    }

    var clearGameOver = function () {
        gameoverDiv.style.display = &apos;none&apos;
    }

    //初始化数据
    var init = function (dom, type, dir) {
        next = SquareFactory.prototype.make(type, dir)
        gameContainers = dom.gameContainers
        nextContainers = dom.nextContainers
        timeDiv = dom.timeDiv
        gameoverDiv = dom.gameoverDiv
        scoreDiv = dom.scoreDiv
        initDiv(gameData, gameContainers, gameDivs)
        initDiv(next.data, nextContainers, nextDivs)
        flushDiv(next.data, nextDivs, next.classData)
    }

    //固定变色
    var fixed = function () {
        for (var i = 0; i &lt; gameData.length; i++) {
            for (var j = 0; j &lt; gameData[0].length; j++) {
                if (checkPonit(cur.orgin, i, j)) {
                    if (gameData[cur.orgin.x + i][cur.orgin.y + j] == 2) {
                        gameData[cur.orgin.x + i][cur.orgin.y + j] = 1
                    }
                }
            }
        }
        flushDiv(gameData, gameDivs, dataClass)
    }

    var setScore = function (data) {
        if (scoreDiv)
            scoreDiv.innerText = data
    }


    var checkClear = function () {
        var lines = 0
        function check(data) {
            return data == 1
        }
        for (var i = gameData.length - 1; i &gt;= 0; i--) {
            var flag = gameData[i].every(check)

            if (flag) {
                lines++
                for (var k = i; k &gt;= 1; k--) {
                    gameData[k] = (gameData[k - 1]).slice(0)
                    dataClass[k] = (dataClass[k - 1]).slice(0)
                }
                gameData[0] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                dataClass[0] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                i++
            }
        }
        return lines

    }

    var checkGameOver = function () {
        if (gameData[0][3] == 1 || gameData[0][4] == 1 || gameData[0][2] == 1 || gameData[0][5] == 1) {//如果原点被占用
            return true
        }
        if (!valid(next.orgin, next.data)) {
            return true
        }


        return false;
    }

    var nextSquare = function (type, dir) {
        cur = next
        setData()
        next = SquareFactory.prototype.make(type, dir)
        flushDiv(gameData, gameDivs, dataClass)
        initSquareClassData(next)
        flushDiv(next.data, nextDivs, next.classData)
    }

    var initSquareClassData = function (squ) {
        for (var i = 0; i &lt; squ.data.length; i++) {
            for (var j = 0; j &lt; squ.data[0].length; j++) {
                if (squ.data[i][j] != 0) {
                    squ.classData[i][j] = squ.class
                }
            }
        }
    }



    //下移
    var down = function () {
        if (cur.canDown(valid)) {
            clearData()
            cur.down()
            setData()
            flushDiv(gameData, gameDivs, dataClass)
            return true
        }
        return false
    }





    var left = function () {
        if (cur.canLeft(valid)) {
            clearData()
            cur.left()
            setData()
            flushDiv(gameData, gameDivs, dataClass)
        }
    }

    var right = function () {
        if (cur.canRight(valid)) {
            clearData()
            cur.right()
            setData()
            flushDiv(gameData, gameDivs, dataClass)
        }
    }

    var rotate = function () {
        if (cur.canRotate(valid)) {
            clearData()
            cur.rotate()
            setData()
            flushDiv(gameData, gameDivs, dataClass)
        }
    }

    var fall = function () {
        while (down()) { }
    }

    //销毁的方法
    var destroyDiv = function () {
        for (var i = 0; i &lt; gameDivs.length; i++) {
            for (var j = 0; j &lt; gameDivs[0].length; j++) {
                gameContainers.removeChild(gameDivs[i][j])
            }
        }
        for (var i = 0; i &lt; nextDivs.length; i++) {
            for (var j = 0; j &lt; nextDivs[0].length; j++) {
                nextContainers.removeChild(nextDivs[i][j])
            }
        }

    }

    this.init = init
    this.down = down
    this.left = left
    this.right = right
    this.rotate = rotate
    this.fall = fall
    this.fixed = fixed
    this.nextSquare = nextSquare
    this.checkClear = checkClear
    this.checkGameOver = checkGameOver
    this.setTime = setTime
    this.showGameOver = showGameOver
    this.clearGameOver = clearGameOver
    this.setScore = setScore
    this.destroyDiv = destroyDiv

}  
</code></pre><p>首先我先来讲一下这个游戏的原理，玩过俄罗斯方块的都清楚他的规则，我们的方块都在一个容器内，不能超出边界。是的，这个容器就是index.html中的<code>local_game</code>，这个容器的大小是400px<em>200px，我们定义一种小方块，每个大小为20px</em>20px，这个容器就能容纳10列*20行也就是200个小方块，现在这个容器被我们的小方块填充满了，游戏中我们所有的小方块有三种状态，1.空的小方块，也就是游戏中那些空闲的区域（白的区域）。2.固定的小方块，已经固定不能移动的小方块。3.正在动的小方块，也就是我门游戏中正在操作的小方块。我们给这三中状态定义假设一个值，比如：第一种状态为<code>0</code>，第二中状态为<code>1</code>，第三种状态为<code>2</code>。我们将这样200个小方块存在一个二维数组中（这里我们称之为dom数组），再将这200个小方块存入一个二维数组中（这里我们称之为状态数组）。当我们按上下左右移动方块时，其实就是更改状态数组，然后在根据状态数组的值改变dom数组中小方块的样式，比如：状态0显示白色，状态1显示蓝色，状态2显示粉色。到这里游戏的基本原理大概就解释完了，看懂了的话，下面的代码实现也就很好理解了。没看明白的话，可能..是我没说清楚吧（Σ( ° △ °|||)︴），那你可以根据源码实现一遍，应该也会理解的。</p>
<p>接下来讲解源码，由上至下开始讲，顶部的模块引入和一些变量生命先将它们忽略，后面用到的时候会提到，先说一些比较重要的变量，<code>gameData</code>就是我们上面提到的保存方块状态的二维数组，gameDivs是我们保存200个小方块的二维数组，还记得游戏上边有显示下一个方块的区域吧，这个区域我们的游戏区域显示远离一致，只是他比较小，大小只有80px*80px，他其中的16个小方块保存在<code>nexDivs</code>二维数组中。接下来的讲解中我们将200个的这种方块称为小方块，游戏中左右上下操作的方块称为下落的方块，以免大家混淆。  </p>
<pre><code>//初始化容器
var initDiv = function (data, container, divs) {
    for (var i = 0; i &lt; data.length; i++) {
        var gameDiv = []
        for (var j = 0; j &lt; data[0].length; j++) {
            var newNode = document.createElement(&quot;div&quot;)
            newNode.className = &apos;none&apos;
            container.appendChild(newNode)
            gameDiv.push(newNode)
        }
        Array.prototype.push.call(divs, gameDiv)
    }
}
//刷新容器显示
var flushDiv = function (data, divs, classes) {
    for (var i = 0; i &lt; data.length; i++) {
        for (var j = 0; j &lt; data[0].length; j++) {
            if (data[i][j] == 0) {
                divs[i][j].className = &apos;none&apos;
            } else {
                if (!classes[i][j])
                    classes[i][j] = &apos;A&apos;
                divs[i][j].className = classes[i][j]
            }
        }
    }
}  
</code></pre><p><code>initDiv</code>就是初始化容器的方法，他生成200个小方块设置样式为none并填充到容器中，因为容器和小方块的样式都是float:left,所以小方块能够顺序排列。<code>flushDiv</code>根据<code>gameData</code>中的数据变更小方块的样式。剩余的方法下面提及。接下里是下落的方块了。  </p>
<h4 id="square-js"><a href="#square-js" class="headerlink" title="square.js"></a>square.js</h4><pre><code>var Square = function () {
    this.data = [
        [0, 0, 0, 0],
        [0, 0, 0, 0],
        [0, 0, 0, 0],
        [0, 0, 0, 0]
    ]

    this.classData = [
        [0, 0, 0, 0],
        [0, 0, 0, 0],
        [0, 0, 0, 0],
        [0, 0, 0, 0]
    ]
    this.dir = 0

    this.orgin = {
        x: 0,
        y: 0
    }
}

Square.prototype.canDown = function (valid) {
    var testDown = {
        x: this.orgin.x + 1,
        y: this.orgin.y,
    }
    return valid(testDown, this.data)
}

Square.prototype.canLeft = function (valid) {
    var testLeft = {
        x: this.orgin.x,
        y: this.orgin.y - 1,
    }
    return valid(testLeft, this.data)
}

Square.prototype.canRight = function (valid) {
    var testRight = {
        x: this.orgin.x,
        y: this.orgin.y + 1,
    }
    return valid(testRight, this.data)
}

Square.prototype.canRotate = function (valid) {
    var d = (this.dir + 1) % 4
    return valid(this.orgin, this.rotates[d])
}

Square.prototype.down = function () {
    this.orgin.x += 1
}

Square.prototype.left = function () {
    this.orgin.y -= 1
}

Square.prototype.right = function () {
    this.orgin.y += 1
}

Square.prototype.rotate = function (num) {
    if (!num)
        num = 1
    this.dir = (this.dir + num) % 4
    this.data = this.rotates[this.dir]
}
export default Square  
</code></pre><p><code>Square</code>是所有下落方块的父类，<code>data</code>是描述方块形状的数组，此数组中只有状态3，因为他只表述运动中的方块，当方块固定下来后，这个方块回销毁，数据将存入game.js中的<code>gameData</code>，<code>orgin</code>是方块当前位置的原点，有了这个原点，移动方块时，只需要移动这个原点，这是一种很巧妙的思维方式，<code>dataClass</code>是保存运动中每个小方块样式的数组，每个下落的方块能翻转4次，<code>dir</code>是保存当前翻转形态的<code>down</code>,<code>right</code>,<code>left</code>是下落方块移动对应的方法，<code>rotate</code>是下落方块翻转的方法。对应的can方法是判断方块的位置是否能做对应的操作。    </p>
<h4 id="squareFactory-js"><a href="#squareFactory-js" class="headerlink" title="squareFactory.js"></a>squareFactory.js</h4><pre><code>import Square from &quot;./square.js&quot;;

var Square1 = function () {

    Square.call(this)

    this.rotates = [
        [
            [0, 0, 0, 0],
            [2, 2, 2, 2],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ], [
            [0, 2, 0, 0],
            [0, 2, 0, 0],
            [0, 2, 0, 0],
            [0, 2, 0, 0]
        ], [
            [0, 0, 0, 0],
            [2, 2, 2, 2],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ], [
            [0, 2, 0, 0],
            [0, 2, 0, 0],
            [0, 2, 0, 0],
            [0, 2, 0, 0]
        ]
    ]
}
Square1.prototype = new Square()

var Square2 = function () {

    Square.call(this)

    this.rotates = [
        [
            [0, 2, 0, 0],
            [2, 2, 2, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ], [
            [0, 2, 0, 0],
            [0, 2, 2, 0],
            [0, 2, 0, 0],
            [0, 0, 0, 0]
        ], [
            [2, 2, 2, 0],
            [0, 2, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ], [
            [0, 2, 0, 0],
            [2, 2, 0, 0],
            [0, 2, 0, 0],
            [0, 0, 0, 0]
        ]
    ]
}
Square2.prototype = new Square()

var Square3 = function () {

    Square.call(this)

    this.rotates = [
        [
            [0, 2, 0, 0],
            [0, 2, 2, 2],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ], [
            [0, 2, 2, 0],
            [0, 2, 0, 0],
            [0, 2, 0, 0],
            [0, 0, 0, 0]
        ], [
            [2, 2, 2, 0],
            [0, 0, 2, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ], [
            [0, 0, 2, 0],
            [0, 0, 2, 0],
            [0, 2, 2, 0],
            [0, 0, 0, 0]
        ]
    ]
}
Square3.prototype = new Square()


var Square4 = function () {

    Square.call(this)

    this.rotates = [
        [
            [0, 0, 0, 0],
            [0, 2, 2, 0],
            [0, 2, 2, 0],
            [0, 0, 0, 0]
        ], [
            [0, 0, 0, 0],
            [0, 2, 2, 0],
            [0, 2, 2, 0],
            [0, 0, 0, 0]
        ], [
            [0, 0, 0, 0],
            [0, 2, 2, 0],
            [0, 2, 2, 0],
            [0, 0, 0, 0]
        ], [
            [0, 0, 0, 0],
            [0, 2, 2, 0],
            [0, 2, 2, 0],
            [0, 0, 0, 0]
        ]
    ]
}
Square4.prototype = new Square()

var Square5 = function () {

    Square.call(this)

    this.rotates = [
        [
            [2, 2, 0, 0],
            [0, 2, 2, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ], [
            [0, 0, 2, 0],
            [0, 2, 2, 0],
            [0, 2, 0, 0],
            [0, 0, 0, 0]
        ], [
            [2, 2, 0, 0],
            [0, 2, 2, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ], [
            [0, 0, 2, 0],
            [0, 2, 2, 0],
            [0, 2, 0, 0],
            [0, 0, 0, 0]
        ]
    ]
}
Square5.prototype = new Square()

var Square6 = function () {

    Square.call(this)

    this.rotates = [
        [
            [0, 0, 2, 0],
            [2, 2, 2, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ], [
            [0, 2, 0, 0],
            [0, 2, 0, 0],
            [0, 2, 2, 0],
            [0, 0, 0, 0]
        ], [
            [2, 2, 2, 0],
            [2, 0, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ], [
            [2, 2, 0, 0],
            [0, 2, 0, 0],
            [0, 2, 0, 0],
            [0, 0, 0, 0]
        ]
    ]
}
Square6.prototype = new Square()

var Square7 = function () {

    Square.call(this)

    this.rotates = [
        [
            [0, 2, 2, 0],
            [2, 2, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ], [
            [0, 2, 0, 0],
            [0, 2, 2, 0],
            [0, 0, 2, 0],
            [0, 0, 0, 0]
        ], [
            [0, 2, 2, 0],
            [2, 2, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ], [
            [0, 2, 0, 0],
            [0, 2, 2, 0],
            [0, 0, 2, 0],
            [0, 0, 0, 0]
        ]
    ]
}
Square7.prototype = new Square()


var SquareFactory = function () { }

SquareFactory.prototype.make = function (index, dir) {
    var classes = [&apos;A&apos;, &apos;B&apos;, &apos;C&apos;, &apos;D&apos;, &apos;E&apos;, &apos;F&apos;, &apos;G&apos;, &apos;H&apos;]
    var s
    index += 1
    switch (index) {
        case 1:
            s = new Square1()
            break;
        case 2:
            s = new Square2()
            break;
        case 3:
            s = new Square3()
            break;
        case 4:
            s = new Square4()
            break;
        case 5:
            s = new Square5()
            break;
        case 6:
            s = new Square6()
            break;
        case 7:
            s = new Square7()
            break;
    }



    s.orgin.x = 0
    s.orgin.y = 3
    s.class = classes[Math.ceil(Math.random() * 9) - 1]

    s.rotate(dir)

    return s;
}

export default SquareFactory  
</code></pre><p>看<code>squareFactory</code>这个名字大家都会明白这是个工厂模块，不明白工厂模式的请自行百度… 在<code>squareFactory</code>中定义了俄罗斯方块中基本的七种方块，并提供了生成方块的方法，这七中方块都继承自<code>square</code>，也就是它们都有移动的方法，不同于父模块，这些方块中的<code>rotates</code>定义了此方块翻转的四种形态。<code>squareFactory</code>的<code>make</code>方法根据参数生成方块，<code>index</code>参数代表要生成的方块，<code>dir</code>表示方块翻转的形态，这两个参数将由game模块传进来，当然这两个方块是随机数，因为每次的方块都是随机的。<code>classes</code>表示的是方块的样式，初始将会给方块也随机赋予一个颜色。  </p>
<h4 id="local-js"><a href="#local-js" class="headerlink" title="local.js"></a>local.js</h4><pre><code>import _ from &apos;lodash&apos;;
import Game from &quot;./game.js&quot;;
export default function () {
    var game

    var timer
    var INTERVAL = 200
    var hours
    var minute
    var seconds

    var score = 0

    var timeCount = 0

    var isStart = false;
    var isPause = false

    var bindKeyEvent = function () {
        document.onkeydown = function (e) {
            switch (e.keyCode) {
                case 38://up
                    game.rotate()
                    break
                case 39://right
                    game.right()
                    break
                case 37://left
                    game.left()
                    break
                case 40://down
                    game.down()
                    break
                case 32://space
                    game.fall()
                    break
            }
        }
    }

    var generateType = function () {
        return Math.ceil(Math.random() * 7) - 1
    }

    var generateDir = function () {
        return Math.ceil(Math.random() * 4) - 1
    }

    var addScore = function (data) {
        switch (data) {
            case 0:
                return 0
            case 1:
                return 10
            case 2:
                return 40
            case 3:
                return 60
            case 4:
                return 80
            default:
                return 100
        }
    }


    var gameOver = function () {
        clearInterval(timer)
        game.showGameOver()
        game.nextSquare(generateType(), generateDir())
        document.onkeydown = null
        timer = null
        timeCount = 0
        score = 0 
        isStart = true
    }

    var clearGameOver = function () {
        game.clearGameOver()
        game.destroyDiv()
        game.setScore(0)
        game.setTime(0)
    }

    var move = function (gamoverDiv) {
        if (!game.down()) {//如果不能下落
            game.fixed()//固定
            score += addScore(game.checkClear())
            game.setScore(score)//消行
            if (game.checkGameOver()) {//判断游戏是否结束
                gameOver()
            } else {
                game.nextSquare(generateType(), generateDir())//生成下一个方块
            }
        }
    }

    var addTime = function () {
        timeCount++;
        if (timeCount % 5 == 0) {
            seconds = timeCount / 5
            var showTime;
            if (seconds &gt;= 3600) {
                var tmp = seconds % 3600
                var tmpMinute = Math.floor(tmp / 60)
                showTime = Math.floor(seconds / 3600) + &quot;小时&quot; + tmpMinute + &apos;分&apos; + tmp % 60 + &apos;秒&apos;
            } else if (seconds &gt;= 60) {
                showTime = Math.floor(seconds / 60) + &quot;分&quot; + seconds % 60 + &apos;秒&apos;
            } else {
                showTime = seconds + &apos;秒&apos;
            }
            game.setTime(showTime)
        }
    }

    var start = function () {
        if (!timer) {
            if(isStart)
                clearGameOver()
            game = new Game()
            var doms = {
                gameContainers: document.getElementById(&quot;local_game&quot;),
                nextContainers: document.getElementById(&quot;local_next&quot;),
                timeDiv: document.getElementById(&quot;local_time&quot;),
                gameoverDiv: document.getElementById(&quot;local_gameover&quot;),
                scoreDiv: document.getElementById(&quot;local_score&quot;)
            }

            game.init(doms, generateType(), generateDir())
            game.nextSquare(generateType(), generateDir())
            bindKeyEvent()

            timer = setInterval(function () {
                move()
                addTime()
            }, INTERVAL)
        }
    }

    var pause = function (e) {
        if (!isPause &amp;&amp; timer) {
            isPause = true
            clearInterval(timer)
            this.innerText = &apos;继续&apos;
            this.onclick = continue_
            document.onkeydown = null
        }
    }

    var continue_ = function () {
        if (isPause) {
            isPause = false
            timer = setInterval(function () {
                move()
                addTime()
            }, INTERVAL)
            this.innerText = &apos;暂停&apos;
            this.onclick = pause
            bindKeyEvent()
        }
    }

    var stop = function () {
        isStart = false
        clearInterval(timer)
        document.onkeydown = null
        timer = null
        game.destroyDiv()
        game.clearGameOver()
        game.setScore(0)
        game.setTime(0)
        timeCount = 0
        score = 0
    }

    var init = function () {
        //绑定开始按钮事件
        document.getElementById(&quot;local_start&quot;).onclick = start
        //绑定暂停按钮事件
        document.getElementById(&quot;local_pause&quot;).onclick = pause
        //绑定结束按钮事件
        document.getElementById(&quot;local_stop&quot;).onclick = stop
    }




    this.init = init

}  
</code></pre><p><code>local</code>模块主要是开始，暂停，继续，结束按钮事件和上下左右空格键盘输入事件以及判断游戏结束的。这块不是我们的重点环节，注释都有，大家自行食用吧。</p>
<h3 id="总体描述"><a href="#总体描述" class="headerlink" title="总体描述"></a>总体描述</h3><p>我们的游戏代码其实就是主页加载<code>local</code>,<code>loacl</code>绑定键盘和按钮事件，事件中调用<code>game</code>,<code>game</code>再调用<code>squareFactory</code>生成下落方块，当我们输入操作时，再通过<code>Square</code>中对应的方法修改下落方块的<code>data</code>数组和<code>orgin</code>原点，<code>game</code>再通过原点和<code>data</code>修改自己的<code>gameData</code>，接着再通过<code>gameData</code>数组来刷新<code>gameDivs</code>和<code>nextDivs</code>中小方块的样式。<br>由于代码细节较多，如方块消行，加分，判断点位置合法性，判断游戏结束等等，我也不可能一一列出啦，所以这些细节大家如果感兴趣的话可以到<a href="https://github.com/yeqingyun/Square" target="_blank" rel="external">源码</a>中去查看。怎么样，明白了吗？有什么问题请下方留言。</p>

      


    
      <div>
        <div class="my_post_copyright">
          <p><span>本文标题:</span><a href="/posts/4a17a002/">用javascript开发一个俄罗斯方块</a></p>
          <p><span>文章作者:</span><a href="/" title="叶青云的个人博客">叶青云</a></p>
          <p><span>发布时间:</span>2016年6月9日 13:36</p>
          <p><span>最后更新:</span>2016年6月9日 13:36</p>
          <p>
            <span>原始链接:</span>
            <a href="/posts/4a17a002/" title="用javascript开发一个俄罗斯方块">http://ilovejava.cn/posts/4a17a002/</a>
          </p>
          <p>
            <span>许可协议:</span>
            <i class="fa fa-creative-commons"></i> 
            <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>
        </div>
      </div>
    

    
      <div>
        <div class="reward-container">
          <a id="rewardButton" href="javascript:void(0)">
            <span class="reward-span">赏</span>
          </a>
          <div id="pay" class="reward-img-container">
            <div id="alipay" class="reward">
              <img id="alipay_qr" class="reward-img" src="/gallery/pay.png">
              <p>听说帅的人都已经打赏了(又支持微信又支持支付宝哟)</p>
            </div>
          </div>
        </div>
      </div>
    

    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/游戏/">游戏</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/算法/">算法</a></li></ul>

      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/posts/172175ba/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">深入浅出javascript(一)</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
      <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#开发环境"><span class="nav-number">1.</span> <span class="nav-text">开发环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码"><span class="nav-number">2.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在线演示"><span class="nav-number">3.</span> <span class="nav-text">在线演示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码分析"><span class="nav-number">4.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#index-html"><span class="nav-number">4.1.</span> <span class="nav-text">index.html</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#game-js"><span class="nav-number">4.2.</span> <span class="nav-text">game.js</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#square-js"><span class="nav-number">4.3.</span> <span class="nav-text">square.js</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#squareFactory-js"><span class="nav-number">4.4.</span> <span class="nav-text">squareFactory.js</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#local-js"><span class="nav-number">4.5.</span> <span class="nav-text">local.js</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总体描述"><span class="nav-number">5.</span> <span class="nav-text">总体描述</span></a></li></ol>
    
    </div>
  </aside>




<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>     
</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2017 一些 All Rights Reserved.
        
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
        
        
          Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>
        
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
      var headerblur = document.getElementById("header-blur");
      headerblur.style.minHeight = window.getComputedStyle(document.getElementById("allheader"), null).height;
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="/js/mathjax.js">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>
<script src="/js/nprogress.js"></script>
<script type="text/javascript">
NProgress.start();
document.onreadystatechange = nprogressLoad;//当页面加载状态改变的时候执行这个方法. 
let progressInterval;
function nprogressLoad() 
{ 
  if(document.readyState == "complete"){ //当页面加载状态 
     NProgress.done();
     clearInterval(progressInterval)
  }else{
    progressInterval = setInterval(function(){
      NProgress.inc()
    },600)  
  }
} 
  
</script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
